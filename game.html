<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تفاصيل اللعبة</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* تحسينات محلية لصفحة التفاصيل (آمنة، لا تغير بقية المشروع) */
    .game-details{
      max-width:920px;
      margin:86px auto 40px;
      padding:16px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      gap:16px;
      align-items:center;
      text-align:center;
    }
    .game-thumb img{
      width:100%;
      max-width:640px;
      height:auto;
      border-radius:12px;
      box-shadow:0 8px 28px rgba(0,0,0,0.45);
      background:#0b1220;
    }
    .game-title{ font-size:28px; font-weight:700; color:#fff; margin:6px 0; text-transform:capitalize; }
    .game-desc{ color:var(--muted,#bfc9d9); max-width:880px; font-size:15px; padding:0 8px; }
    .meta{ width:100%; max-width:760px; display:flex; flex-direction:column; gap:12px; align-items:stretch; text-align:right; padding:0 8px; }
    .versions { display:flex; flex-direction:column; gap:10px; }
    .version-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; background:rgba(255,255,255,0.02); border-radius:10px; border:1px solid rgba(255,255,255,0.03); }
    .ver-info{ flex:1; color:var(--muted,#cbd5e1); font-size:15px; text-align:right; direction:rtl; }
    .version-actions{ display:flex; gap:8px; align-items:center; }
    .download-btn{ background:linear-gradient(90deg,#facc15,#ffd54a); color:#000; padding:10px 14px; border-radius:10px; font-weight:700; text-decoration:none; display:inline-block; }
    .edit-btn{ background:#ffd166; color:#000; padding:8px 10px; border-radius:8px; border:none; cursor:pointer; }
    .back-link{ display:inline-block; margin-top:6px; color:#a5d8ff; text-decoration:underline; }
    .no-versions{ color:var(--muted,#9ca3af); padding:10px 8px; }
    @media (max-width:720px){
      .game-details { margin:70px 10px 30px; padding:12px; }
      .game-title{ font-size:22px; }
    }
  </style>
</head>
<body>

  <main class="game-details" id="gameDetails">
    <div class="game-thumb">
      <img id="gImg" src="/no-image.png" alt="صورة اللعبة">
    </div>

    <h1 id="gName" class="game-title">اسم اللعبة</h1>

    <p id="gDesc" class="game-desc">وصف اللعبة...</p>

    <!-- رابط المصدر يبقى مرئياً في صفحة التفاصيل -->
    <a id="gSource" class="source-link" href="#" target="_blank" rel="noopener noreferrer" style="display:none">مصدر (Google Play)</a>

    <div class="meta">
      <div class="versions-title" style="font-weight:700;color:#fff">الإصدارات</div>
      <div id="versions" class="versions"></div>
      <div id="noVersions" class="no-versions" style="display:none">لا توجد إصدارات متاحة</div>
    </div>

    <a id="backToIndex" href="index.html" class="back-link">« عودة للقائمة</a>
  </main>

  <footer class="footer">
  <p>© 2026 موقع الألعاب. جميع الحقوق محفوظة.</p>
  <nav class="footer-links">
    <a href="privacy.html">سياسة الخصوصية</a> |
    <a href="terms.html">الشروط والأحكام</a>
  </nav>
</footer>

  <script>
    (function () {
      // Helper: قراءة query param
      function getQueryParam(name) {
        try {
          return new URL(location.href).searchParams.get(name);
        } catch (e) {
          return null;
        }
      }

      const gImg = document.getElementById('gImg');
      const gNameEl = document.getElementById('gName');
      const gDescEl = document.getElementById('gDesc');
      const gSourceEl = document.getElementById('gSource');
      const versionsContainer = document.getElementById('versions');
      const noVersionsEl = document.getElementById('noVersions');
      const backToIndex = document.getElementById('backToIndex');

      const nameParam = getQueryParam('name') || getQueryParam('game') || '';

      // 1) حاول جلب كائن اللعبة من sessionStorage (عند النقر من الصفحة الرئيسية حفظنا selectedGame)
      let game = null;
      try {
        const sel = sessionStorage.getItem('selectedGame');
        if (sel) {
          game = JSON.parse(sel);
          // نزيله لتجنّب بقاء بيانات قديمة
          sessionStorage.removeItem('selectedGame');
        }
      } catch (e) {
        game = null;
      }

      // 2) إن لم نجده في sessionStorage، نبحث في localStorage (adminGames أو allGames)
      if (!game && nameParam) {
        try {
          const adminGames = JSON.parse(localStorage.getItem('adminGames') || '[]');
          const lower = (nameParam || '').trim().toLowerCase();
          game = (adminGames || []).find(g => (g.name || '').trim().toLowerCase() === lower) || null;

          if (!game) {
            const maybe = JSON.parse(localStorage.getItem('allGames') || '[]');
            game = (maybe || []).find(g => (g.name || '').trim().toLowerCase() === lower) || null;
          }
        } catch (e) {
          game = null;
        }
      }

      // 3) إن لم نجد اللعبة، نعرض رسالة مفيدة ونوقف العملية
      if (!game) {
        const displayName = nameParam ? decodeURIComponent(nameParam) : 'اللعبة غير محددة';
        gNameEl.textContent = displayName;
        gDescEl.textContent = 'تفاصيل هذه اللعبة غير متاحة محلياً. إذا أتيت من الصفحة الرئيسية فحاول النقر مباشرة من البطاقة، أو أضف اللعبة في لوحة الأدمن.';
        if (gSourceEl) gSourceEl.style.display = 'none';
        if (noVersionsEl) noVersionsEl.style.display = 'block';
        // رابط العودة يقود إلى index مع محاولة إبقائه بسيطاً
        backToIndex.href = 'index.html';
        return;
      }

      // 4) لدينا الكائن — اعرضه
      gNameEl.textContent = game.name || (nameParam ? decodeURIComponent(nameParam) : 'اللعبة');
      gDescEl.textContent = game.desc || '';
      gImg.src = game.img || '/no-image.png';

      // رابط البحث في Google Play
      try {
        const playHref = `https://play.google.com/store/search?q=${encodeURIComponent(game.name)}&c=apps`;
        gSourceEl.href = playHref;
        gSourceEl.style.display = 'inline-block';
      } catch (e) {
        // ignore
      }

      // التأكد من رابط العودة يعود لصفحة اللعبة مع الاسم
      backToIndex.href = `index.html`;

      // 5) عرض الإصدارات وبناء روابط إلى download.html مع تمرير كل المعلومات
      const versions = (game.versions && game.versions.length) ? game.versions : [];
      versionsContainer.innerHTML = '';

      if (!versions.length) {
        noVersionsEl.style.display = 'block';
        return;
      } else {
        noVersionsEl.style.display = 'none';
        versions.forEach((v) => {
          const row = document.createElement('div');
          row.className = 'version-row';

          const info = document.createElement('div');
          info.className = 'ver-info';
          const verText = v.v ? `${v.v}` : 'الإصدار';
          const sizeText = v.size ? ` • ${v.size}` : '';
          info.textContent = verText + sizeText;

          const actions = document.createElement('div');
          actions.className = 'version-actions';

          // params: نمرر name, ver, size, link, img, desc إلى download.html
          const params = new URLSearchParams();
          params.set('name', game.name || '');
          params.set('ver', v.v || '');
          params.set('size', v.size || '');
          params.set('link', v.link || ''); // قد يكون # أو رابط فعلي
          params.set('img', game.img || '');
          params.set('desc', game.desc || '');

          const dlHref = `download.html?${params.toString()}`;

          const dl = document.createElement('a');
          dl.className = 'download-btn';
          dl.textContent = 'تحميل';
          dl.href = dlHref;
          dl.target = '_self';

          actions.appendChild(dl);

          // زر تحرير يظهر فقط لو المستخدم أدمن (آمن، لا يغيّر سلوك التحميل)
          if (location.search.includes('admin=true') || localStorage.getItem('isAdmin') === 'true') {
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'edit-btn';
            editBtn.textContent = '✏️';
            editBtn.onclick = () => { location.href = `index.html?admin=true`; };
            actions.appendChild(editBtn);
          }

          row.appendChild(info);
          row.appendChild(actions);
          versionsContainer.appendChild(row);
        });
      }

    })();
  </script>
</body>
</html>

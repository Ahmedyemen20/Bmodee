<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تفاصيل اللعبة</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* تحسينات محلية بسيطة لصفحة التفاصيل */
    .game-details{ max-width:920px; margin:96px auto 40px; padding:16px; box-sizing:border-box; display:flex; flex-direction:column; gap:16px; align-items:center; text-align:center; }
    .game-thumb img{ width:100%; max-width:640px; height:auto; border-radius:12px; box-shadow:0 8px 28px rgba(0,0,0,0.45); }
    .game-title{ font-size:28px; font-weight:700; color:#fff; margin:6px 0; text-transform:capitalize; }
    .game-desc{ color:var(--muted,#bfc9d9); max-width:880px; font-size:15px; padding:0 8px; }
    .meta{ width:100%; max-width:760px; display:flex; flex-direction:column; gap:12px; align-items:stretch; text-align:right; padding:0 8px; }
    .versions { display:flex; flex-direction:column; gap:10px; }
    .version-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; background:rgba(255,255,255,0.02); border-radius:10px; border:1px solid rgba(255,255,255,0.03); }
    .ver-info{ flex:1; color:var(--muted,#cbd5e1); font-size:15px; text-align:right; direction:rtl; }
    .version-actions{ display:flex; gap:8px; align-items:center; }
    .download-btn{ background:linear-gradient(90deg,#facc15,#ffd54a); color:#000; padding:10px 14px; border-radius:10px; font-weight:700; text-decoration:none; display:inline-block; }
    .edit-btn{ background:#ffd166; color:#000; padding:8px 10px; border-radius:8px; border:none; cursor:pointer; }
    .back-link{ display:inline-block; margin-top:6px; color:#a5d8ff; text-decoration:underline; }
  </style>
</head>
<body>

  <main class="game-details" id="gameDetails">
    <div class="game-thumb">
      <img id="gImg" src="/no-image.png" alt="صورة اللعبة">
    </div>

    <h1 id="gName" class="game-title">اسم اللعبة</h1>

    <p id="gDesc" class="game-desc">وصف اللعبة...</p>

    <!-- رابط المصدر (يُترك مرئياً في صفحة اللعبة) -->
    <a id="gSource" class="source-link" href="#" target="_blank" rel="noopener noreferrer">مصدر (Google Play)</a>

    <div class="meta">
      <div class="versions-title">الإصدارات</div>
      <div id="versions" class="versions"></div>
      <div id="noVersions" class="no-versions" style="display:none">لا توجد إصدارات متاحة</div>
    </div>

    <a href="index.html" class="back-link">« عودة للقائمة</a>
  </main>

  <footer class="footer">
  <p>© 2026 موقع الألعاب. جميع الحقوق محفوظة.</p>
  <nav class="footer-links">
    <a href="privacy.html">سياسة الخصوصية</a> |
    <a href="terms.html">الشروط والأحكام</a>
  </nav>
</footer>

  <script>
    // game.html — يهيئ صفحة التفاصيل ويبني روابط تحميل تمرر كل المعلومات إلى download.html
    (function () {
      function getQueryParam(name) {
        const u = new URL(location.href);
        return u.searchParams.get(name);
      }

      const gameName = getQueryParam('name') || getQueryParam('game') || '';
      const gImg = document.getElementById('gImg');
      const gNameEl = document.getElementById('gName');
      const gDescEl = document.getElementById('gDesc');
      const gSourceEl = document.getElementById('gSource');
      const versionsContainer = document.getElementById('versions');
      const noVersionsEl = document.getElementById('noVersions');

      if (!gameName) {
        gNameEl.textContent = 'اللعبة غير محددة';
        gDescEl.textContent = 'لم يتم تمرير اسم اللعبة في رابط الصفحة.';
        gSourceEl.style.display = 'none';
        noVersionsEl.style.display = 'block';
        return;
      }

      // قراءة الألعاب من localStorage (adminGames) أو مفتاح بديل
      let adminGames = [];
      try { adminGames = JSON.parse(localStorage.getItem('adminGames') || '[]'); } catch(e){ adminGames = []; }

      function findGameByName(name, list) {
        if (!list || !list.length) return null;
        const n = name.trim().toLowerCase();
        return list.find(g => (g.name || '').trim().toLowerCase() === n) || null;
      }

      let game = findGameByName(gameName, adminGames);

      // إذا لم تجده في adminGames حاول البحث في allGames أو baseGames المخزنة
      if (!game) {
        try {
          const maybe = JSON.parse(localStorage.getItem('allGames') || 'null');
          if (maybe && Array.isArray(maybe)) {
            game = findGameByName(gameName, maybe);
          }
        } catch(e){}
      }

      // لو لم نجد اللعبة، نظهر رسالة واضحة
      if (!game) {
        gNameEl.textContent = decodeURIComponent(gameName);
        gDescEl.textContent = 'تفاصيل هذه اللعبة غير متاحة محلياً. أضف اللعبة أو تأكد من الاسم.';
        gSourceEl.style.display = 'none';
        noVersionsEl.style.display = 'block';
        return;
      }

      // عرض بيانات اللعبة
      gNameEl.textContent = game.name || decodeURIComponent(gameName);
      gDescEl.textContent = game.desc || '';
      gImg.src = game.img || '/no-image.png';
      const playHref = `https://play.google.com/store/search?q=${encodeURIComponent(game.name)}&c=apps`;
      gSourceEl.href = playHref;
      gSourceEl.style.display = 'inline-block';

      const versions = (game.versions && game.versions.length) ? game.versions : [];
      versionsContainer.innerHTML = '';

      if (!versions.length) {
        noVersionsEl.style.display = 'block';
      } else {
        noVersionsEl.style.display = 'none';
        versions.forEach((v) => {
          const row = document.createElement('div');
          row.className = 'version-row';

          const info = document.createElement('div');
          info.className = 'ver-info';
          const verText = v.v ? `${v.v}` : 'الإصدار';
          const sizeText = v.size ? ` • ${v.size}` : '';
          info.textContent = verText + sizeText;

          const actions = document.createElement('div');
          actions.className = 'version-actions';

          // بناء رابط إلى download.html و تمرير كل المعلومات كـ query params
          const params = new URLSearchParams();
          params.set('name', game.name || '');
          params.set('ver', v.v || '');
          params.set('size', v.size || '');
          // تمرير رابط التحميل الفعلي (إن وُجد) كـ link param — نضعه مشفراً بواسطة encodeURIComponent آلياً عبر toString
          params.set('link', v.link || '');
          // تمرير صورة ووصف أيضاً حتى تظهر في صفحة التحميل دون حاجة لقراءة localStorage
          params.set('img', game.img || '');
          params.set('desc', game.desc || '');

          const dlHref = `download.html?${params.toString()}`;

          const dl = document.createElement('a');
          dl.className = 'download-btn';
          dl.textContent = 'تحميل';
          dl.href = dlHref;
          // نفتح داخل نفس الصفحة ليتحول المستخدم لصفحة التحميل
          dl.target = '_self';

          actions.appendChild(dl);

          // زر تحرير يظهر للمشرفين فقط
          if (location.search.includes('admin=true') || localStorage.getItem('isAdmin') === 'true') {
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'edit-btn';
            editBtn.textContent = '✏️';
            editBtn.onclick = () => {
              location.href = `index.html?admin=true`;
            };
            actions.appendChild(editBtn);
          }

          row.appendChild(info);
          row.appendChild(actions);
          versionsContainer.appendChild(row);
        });
      }

    })();
  </script>
</body>
</html>

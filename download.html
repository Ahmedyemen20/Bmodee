<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تحميل اللعبة</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* تحسينات محلية لصفحة التحميل */
    .download-page {
      max-width:920px;
      margin:86px auto 40px;
      padding:16px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      gap:16px;
      align-items:center;
      text-align:center;
    }
    .download-thumb img { width:100%; max-width:420px; height:auto; border-radius:12px; box-shadow:0 8px 28px rgba(0,0,0,0.45); }
    .download-title { font-size:26px; font-weight:700; color:#fff; margin:6px 0; }
    .download-desc { color:var(--muted,#bfc9d9); font-size:15px; max-width:820px; padding:0 8px; }
    .download-area { width:100%; max-width:760px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); padding:14px; border-radius:12px; display:flex; gap:12px; flex-direction:column; align-items:stretch; }
    .version-row { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border-radius:10px; }
    .ver-info { text-align:right; direction:rtl; color:var(--muted,#cbd5e1); }
    .download-btn { display:inline-block; background:linear-gradient(90deg,#facc15,#ffd54a); color:#000; padding:12px 18px; border-radius:12px; font-weight:800; text-decoration:none; border:0; cursor:pointer; }
    .download-btn[aria-disabled="true"]{ opacity:0.6; pointer-events:none; }
    .countdown { font-weight:700; color:#fff; background:rgba(0,0,0,0.25); padding:8px 12px; border-radius:8px; display:inline-block; }
    .notice { color:var(--muted,#9ca3af); font-size:14px; }
    .back-link { margin-top:8px; color:#a5d8ff; text-decoration:underline; display:inline-block; }
    .no-versions { color:var(--muted,#9ca3af); padding:8px 0; }
    .btn-group { display:flex; gap:8px; align-items:center; }
    .direct-download-loading { display:inline-block; width:18px; height:18px; border:3px solid rgba(0,0,0,0.12); border-top-color:#000; border-radius:50%; animation:spin 1s linear infinite; vertical-align:middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width:720px){
      .download-page { margin:70px 10px 30px; }
      .download-title { font-size:20px; }
      .version-row { flex-direction:column; align-items:stretch; }
      .btn-group { justify-content:flex-start; }
    }
  </style>
</head>
<body>
  <main class="download-page" id="downloadPage">
    <div class="download-thumb">
      <img id="dImg" src="/no-image.png" alt="صورة اللعبة">
    </div>

    <h1 id="dName" class="download-title">تحميل</h1>
    <p id="dDesc" class="download-desc">جارٍ جلب معلومات التحميل...</p>

    <div class="download-area" id="downloadArea">
      <div id="versionsBlock">
        <div class="versions-title">الإصدارات المتاحة</div>
        <div id="versionList" class="version-list"></div>
        <div id="noVersions" class="no-versions" style="display:none">لا توجد إصدارات متاحة للتحميل</div>
      </div>

      <div id="sourceBlock" style="text-align:center;">
        <div style="margin-top:6px;">
          <a id="playSearch" class="alt-link" href="#" target="_blank" rel="noopener noreferrer">ابحث عن التطبيق في Google Play</a>
        </div>
      </div>

      <div id="messages" style="text-align:center;"></div>
    </div>

    <a id="backToGame" class="back-link" href="#">« العودة إلى صفحة اللعبة</a>
  </main>

  <footer class="footer">
  <p>© 2026 موقع الألعاب. جميع الحقوق محفوظة.</p>
  <nav class="footer-links">
    <a href="privacy.html">سياسة الخصوصية</a> |
    <a href="terms.html">الشروط والأحكام</a>
  </nav>
</footer>

  <script>
    // PROXY_BASE مضبوط على Worker الخاص بك (انسخته كما طلبت)
    const PROXY_BASE = 'https://hidden-truth-262e.ahmedyemen20066.workers.dev?url=';

    (function () {
      function q(name){ return new URL(location.href).searchParams.get(name); }
      const nameParam = q('name') || '';
      const verParam = q('ver') || q('version') || '';
      const sizeParam = q('size') || '';
      const linkParam = q('link') || ''; // رابط تحميل مباشر إن وُجد
      const imgParam = q('img') || '';
      const descParam = q('desc') || '';

      const dImg = document.getElementById('dImg');
      const dName = document.getElementById('dName');
      const dDesc = document.getElementById('dDesc');
      const versionList = document.getElementById('versionList');
      const noVersions = document.getElementById('noVersions');
      const playSearch = document.getElementById('playSearch');
      const messages = document.getElementById('messages');
      const backToGame = document.getElementById('backToGame');

      function safe(s){ return (s===null||s===undefined) ? '' : String(s); }

      backToGame.href = nameParam ? `game.html?name=${encodeURIComponent(nameParam)}` : 'index.html';
      playSearch.href = nameParam ? `https://play.google.com/store/search?q=${encodeURIComponent(nameParam)}&c=apps` : '#';

      let versions = [];
      let game = null;

      if (nameParam) {
        game = {
          name: decodeURIComponent(nameParam),
          img: decodeURIComponent(imgParam || ''),
          desc: decodeURIComponent(descParam || ''),
          versions: []
        };
        if (linkParam || verParam || sizeParam) {
          game.versions.push({
            v: decodeURIComponent(verParam || ''),
            size: decodeURIComponent(sizeParam || ''),
            link: decodeURIComponent(linkParam || '')
          });
        } else {
          try {
            const adminGames = JSON.parse(localStorage.getItem('adminGames') || '[]');
            const found = (adminGames||[]).find(g => (g.name||'').trim().toLowerCase() === (nameParam||'').trim().toLowerCase());
            if (found) {
              game = found;
            }
          } catch(e){}
        }
      }

      if (!game) {
        dName.textContent = 'اللعبة غير موجودة';
        dDesc.textContent = 'لم يتم تمرير بيانات كافية لعرض صفحة التحميل.';
        messages.innerHTML = '<div class="notice">تأكد أنك ضغط زر "تحميل" من صفحة التفاصيل أو أعد المحاولة من الصفحة الرئيسية.</div>';
        playSearch.style.display = 'inline-block';
        noVersions.style.display = 'block';
        return;
      }

      dName.textContent = safe(game.name || decodeURIComponent(nameParam));
      dDesc.textContent = safe(game.desc || '');
      dImg.src = safe(game.img || '/no-image.png');

      versions = (game.versions && game.versions.length) ? game.versions : [];
      versionList.innerHTML = '';

      if (!versions.length) {
        noVersions.style.display = 'block';
        messages.innerHTML = '<div class="notice">لا توجد إصدارات مسجلة لهذه اللعبة.</div>';
        return;
      } else {
        noVersions.style.display = 'none';
        versions.forEach((v, idx) => {
          const row = document.createElement('div');
          row.className = 'version-row';

          const info = document.createElement('div');
          info.className = 'ver-info';
          const verText = v.v ? `${v.v}` : 'الإصدار';
          const sizeText = v.size ? ` • ${v.size}` : '';
          info.textContent = verText + sizeText;

          const actions = document.createElement('div');

          // عنصر countdown وازرار التحميل (فتح عبر البروكسي + تحميل مباشر عبر البروكسي)
          const countEl = document.createElement('span');
          countEl.className = 'countdown';
          const countdownSeconds = 5; // مدة العدّ (يمكن تعديلها)
          countEl.textContent = `التحميل خلال ${countdownSeconds}...`;

          const openA = document.createElement('a');
          openA.className = 'download-btn';
          openA.textContent = 'تحميل اللعبة من Google play';
          
          // دايم يفتح بحث Google Play باسم اللعبة
    openA.href = `https://play.google.com/store/search?q=${encodeURIComponent(game.name)}&c=apps`;
      openA.target = '_blank';
      openA.rel = 'noopener noreferrer';

          const directBtn = document.createElement('button');
          directBtn.className = 'download-btn';
          directBtn.textContent = 'تحميل مباشر';
          directBtn.setAttribute('aria-disabled', 'true');
          directBtn.type = 'button';

          const btnGroup = document.createElement('div');
          btnGroup.className = 'btn-group';
          
          btnGroup.appendChild(openA);
          

          actions.appendChild(btnGroup);

          row.appendChild(info);
          row.appendChild(actions);
          versionList.appendChild(row);

          const href = (v.link && v.link.trim() && v.link.trim() !== '#') ? v.link.trim() : null;

          // شغل العد لكل زر
          (function(startEl, openEl, directEl, hrefVal, verObj){
            let t = countdownSeconds;
            const interval = setInterval(() => {
              t--;
              if (t > 0) {
                startEl.textContent = `التحميل خلال ${t}...`;
              } else {
                clearInterval(interval);
                startEl.style.display = 'none';

                openEl.setAttribute('aria-disabled', 'false');
                // لو عندنا رابط فعلي نمرره عبر البروكسي ليصل بتهيئة CORS
                if (hrefVal) {
                  const proxyUrl = PROXY_BASE + encodeURIComponent(hrefVal);
                  openEl.href = proxyUrl;
                  openEl.target = '_blank';
                  openEl.rel = 'noopener noreferrer';
                } else {
                  openEl.href = `download.html?name=${encodeURIComponent(game.name)}&ver=${encodeURIComponent(verObj.v || '')}`;
                  openEl.target = '_self';
                }

                directEl.setAttribute('aria-disabled', 'false');
                directEl.addEventListener('click', async (ev) => {
                  ev.preventDefault();
                  if (!hrefVal) {
                    alert('لا يوجد رابط تحميل مباشر لهذا الإصدار.');
                    return;
                  }

                  // UI: مؤشر تحميل
                  const spinner = document.createElement('span');
                  spinner.className = 'direct-download-loading';
                  directEl.disabled = true;
                  const prevText = directEl.textContent;
                  directEl.textContent = ' ';
                  directEl.appendChild(spinner);

                  try {
                    // استخدم البروكسي لجلب الملف (يتجاوز CORS)
                    const proxyUrl = PROXY_BASE + encodeURIComponent(hrefVal);
                    const resp = await fetch(proxyUrl, { method: 'GET' });
                    if (!resp.ok) throw new Error('فشل جلب الملف: ' + resp.status);
                    const blob = await resp.blob();

                    // إستنتاج اسم الملف من header أو من الرابط
                    let filename = 'download';
                    const cd = resp.headers.get('content-disposition');
                    if (cd && /filename="?([^"]+)"?/.test(cd)) {
                      filename = RegExp.$1;
                    } else {
                      try {
                        const urlPath = new URL(hrefVal).pathname;
                        const parts = urlPath.split('/');
                        const last = parts.pop() || parts.pop();
                        if (last) filename = last;
                      } catch(e){}
                    }

                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);

                    messages.innerHTML = `<div class="notice">بدأ التنزيل (${filename}). إذا لم يبدأ تلقائياً افتح الرابط يدوياً.</div>`;
                  } catch (err) {
                    console.warn('Direct download failed, fallback to opening link:', err);
                    alert('لم أتمكن من تنزيل الملف مباشرةً. سيتم فتح الرابط في تبويب جديد.');
                    window.open(hrefVal, '_blank', 'noopener');
                  } finally {
                    directEl.disabled = false;
                    // إزالة المؤشر واستعادة النص
                    if (directEl.contains(spinner)) directEl.removeChild(spinner);
                    directEl.textContent = prevText;
                  }
                }, { once: true });
              }
            }, 1000);
          })(countEl, openA, directBtn, href, v);
        });
      }

    })();
  </script>
</body>
</html>

<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تحميل اللعبة</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* تحسينات محلية لصفحة التحميل (لا تغيّر بقية المشروع) */
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .download-page {
      max-width:920px;
      margin:86px auto 40px;
      padding:16px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      gap:16px;
      align-items:center;
      text-align:center;
    }
    .download-thumb img { width:100%; max-width:420px; height:auto; border-radius:12px; box-shadow:0 8px 28px rgba(0,0,0,0.45); }
    .download-title { font-size:26px; font-weight:700; color:#fff; margin:6px 0; }
    .download-desc { color:var(--muted,#bfc9d9); font-size:15px; max-width:820px; padding:0 8px; }
    .download-area { width:100%; max-width:760px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); padding:14px; border-radius:12px; display:flex; gap:12px; flex-direction:column; align-items:stretch; }
    .version-list { display:flex; flex-direction:column; gap:10px; }
    .version-row { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border-radius:10px; background:transparent; }
    .ver-info { text-align:right; direction:rtl; color:var(--muted,#cbd5e1); }
    .download-btn { display:inline-block; background:linear-gradient(90deg,#facc15,#ffd54a); color:#000; padding:10px 14px; border-radius:10px; font-weight:700; text-decoration:none; }
    .alt-link { color:#4da3ff; text-decoration:underline; }
    .notice { color:var(--muted,#9ca3af); font-size:14px; }
    .back-link { margin-top:8px; color:#a5d8ff; text-decoration:underline; display:inline-block; }
    .no-versions { color:var(--muted,#9ca3af); padding:8px 0; }
    @media (max-width:720px){
      .download-page { margin:70px 10px 30px; }
      .download-title { font-size:20px; }
    }
  </style>
</head>
<body>
  <main class="download-page" id="downloadPage">
    <div class="download-thumb">
      <img id="dImg" src="/no-image.png" alt="صورة اللعبة">
    </div>

    <h1 id="dName" class="download-title">تحميل</h1>
    <p id="dDesc" class="download-desc">جارٍ جلب معلومات التحميل...</p>

    <div class="download-area" id="downloadArea">
      <div id="versionsBlock">
        <div class="versions-title">الإصدارات المتاحة</div>
        <div id="versionList" class="version-list"></div>
        <div id="noVersions" class="no-versions" style="display:none">لا توجد إصدارات متاحة للتحميل</div>
      </div>

      <div id="sourceBlock" style="text-align:center;">
        <div style="margin-top:6px;">
          <a id="playSearch" class="alt-link" href="#" target="_blank" rel="noopener noreferrer">ابحث عن التطبيق في Google Play</a>
        </div>
      </div>

      <div id="messages" style="text-align:center;"></div>
    </div>

    <a id="backToGame" class="back-link" href="#">« العودة إلى صفحة اللعبة</a>
  </main>

  <footer class="footer">
    <p>© 2026 موقع الألعاب. جميع الحقوق محفوظة.</p>
  </footer>

  <script>
    // download.html — ربط بمعلومات اللعبة وعرض روابط التحميل
    (function () {
      // قراءة Query params بأمان
      function q(name) {
        const u = new URL(location.href);
        return u.searchParams.get(name);
      }

      const nameParam = q('name') || q('game') || '';
      const verParam = q('ver') || q('version') || '';
      const linkParam = q('link') || ''; // لو أُرسل رابط مباشر في الرابط

      const dImg = document.getElementById('dImg');
      const dName = document.getElementById('dName');
      const dDesc = document.getElementById('dDesc');
      const versionList = document.getElementById('versionList');
      const noVersions = document.getElementById('noVersions');
      const playSearch = document.getElementById('playSearch');
      const messages = document.getElementById('messages');
      const backToGame = document.getElementById('backToGame');

      function safeText(s) { return (s===null||s===undefined) ? '' : String(s); }

      if (!nameParam) {
        dName.textContent = 'لم يتم تحديد اللعبة';
        dDesc.textContent = 'لا يمكن إكمال عملية التحميل لأن اسم اللعبة غير موجود في الرابط.';
        messages.innerHTML = '<div class="notice">تحقق أنك فتحت الرابط عبر زر "تحميل" من صفحة التفاصيل أو أعد المحاولة من الصفحة الرئيسية.</div>';
        playSearch.style.display = 'none';
        noVersions.style.display = 'block';
        backToGame.href = 'index.html';
        return;
      }

      // الرابط البحثي على Google Play
      playSearch.href = `https://play.google.com/store/search?q=${encodeURIComponent(nameParam)}&c=apps`;

      // نحاول قراءة adminGames من localStorage
      let adminGames = [];
      try { adminGames = JSON.parse(localStorage.getItem('adminGames') || '[]'); } catch(e) { adminGames = []; }

      // اختصر البحث عن اسم اللعبة في adminGames (مطابقة case-insensitive)
      function findGame(list, name) {
        const n = (name||'').trim().toLowerCase();
        return (list||[]).find(g => (g.name||'').trim().toLowerCase() === n) || null;
      }

      let game = findGame(adminGames, nameParam);

      // إذا ما وجدناها في adminGames — نجرب أن نأخذ بيانات من window.history.state أو localStorage 'lastGames' أو غيرها
      if (!game) {
        // محاولة: قد يكون الموقع خزّن ألعاب تحت مفتاح 'baseGames' أو 'allGames' — نتحقق بدون خطأ
        try {
          const maybe = JSON.parse(localStorage.getItem('allGames') || 'null');
          if (maybe && Array.isArray(maybe)) {
            game = findGame(maybe, nameParam);
          }
        } catch(e){}
      }

      // إذا لم توجد اللعبة نعرض رسالة ونوجه المستخدم لخيار البحث في Google Play
      if (!game) {
        dName.textContent = decodeURIComponent(nameParam);
        dDesc.textContent = 'لم يتم العثور على تفاصيل هذه اللعبة محلياً.';
        versionList.innerHTML = '';
        noVersions.style.display = 'block';
        messages.innerHTML = '<div class="notice">إن لم يكن هناك رابط تحميل مباشر، استخدم زر البحث في Google Play أو تواصل مع مدير الموقع لإضافة إصدار التحميل.</div>';
        backToGame.href = `game.html?name=${encodeURIComponent(nameParam)}`;
        return;
      }

      // عثرنا على اللعبة — نعرض بياناتها
      dName.textContent = safeText(game.name);
      dDesc.textContent = safeText(game.desc || '');
      dImg.src = safeText(game.img || '/no-image.png');
      backToGame.href = `game.html?name=${encodeURIComponent(game.name)}`;

      const versions = (game.versions && game.versions.length) ? game.versions : [];

      // إذا أُرسِل linkParam في رابط الصفحة فنجعلها نسخة وحيدة قابلة للتحميل
      if (linkParam && linkParam.trim() !== '') {
        versionList.innerHTML = '';
        const row = document.createElement('div');
        row.className = 'version-row';
        const info = document.createElement('div');
        info.className = 'ver-info';
        info.textContent = verParam ? `${verParam}` : 'رابط تحميل مباشر';
        const actions = document.createElement('div');
        const a = document.createElement('a');
        a.className = 'download-btn';
        a.href = linkParam;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = 'تحميل الآن';
        actions.appendChild(a);
        row.appendChild(info);
        row.appendChild(actions);
        versionList.appendChild(row);
        noVersions.style.display = 'none';
        return;
      }

      // عرض الإصدارات إن وُجدت
      versionList.innerHTML = '';
      if (!versions.length) {
        noVersions.style.display = 'block';
        messages.innerHTML = '<div class="notice">لا توجد إصدارات مُسجلة لهذه اللعبة. حاول البحث في Google Play أو تواصل مع المُشرف.</div>';
        return;
      } else {
        noVersions.style.display = 'none';
        // إذا كان هناك باراميتر verParam، حاول اختيار هذا الإصدار أولاً
        let selectedIndex = -1;
        if (verParam) {
          selectedIndex = versions.findIndex(v => (v.v||'').toString() === verParam.toString());
        }
        // إذا لم يوجد باراميتر أو لم نجد المطابقة نعرض كل الإصدارات كقائمة
        versions.forEach((v, idx) => {
          const row = document.createElement('div');
          row.className = 'version-row';

          const info = document.createElement('div');
          info.className = 'ver-info';
          const verText = v.v ? `${v.v}` : 'الإصدار';
          const sizeText = v.size ? ` • ${v.size}` : '';
          info.textContent = verText + sizeText;

          const actions = document.createElement('div');

          const href = (v.link && v.link.trim() && v.link.trim() !== '#') ? v.link.trim() : null;

          const a = document.createElement('a');
          a.className = 'download-btn';
          a.textContent = 'تحميل';
          if (href) {
            a.href = href;
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
          } else {
            // لو ما فيه رابط مباشر توجه إلى نفس الصفحة مع params واضحة (أبقينا سلوك آمن)
            a.href = `download.html?name=${encodeURIComponent(game.name)}&ver=${encodeURIComponent(v.v || '')}`;
            a.target = '_self';
          }

          actions.appendChild(a);

          row.appendChild(info);
          row.appendChild(actions);
          versionList.appendChild(row);

          // إذا كان هذا الإصدار المطلوب (verParam) نجعل الصفحة تبرزها
          if (selectedIndex === idx) {
            row.style.background = 'rgba(250,204,21,0.08)';
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        });
      }

    })();
  </script>
</body>
</html>
